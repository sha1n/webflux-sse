<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Stream Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .status {
            padding: 10px 20px;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            font-size: 14px;
        }
        .connected {
            color: #28a745;
        }
        .disconnected {
            color: #dc3545;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        tr:hover {
            background-color: #f8f9fa;
        }
        .timestamp {
            white-space: nowrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .title {
            font-weight: 500;
        }
        .description {
            color: #666;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .nav {
            background: #e9ecef;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
        }
        .nav a {
            color: #007bff;
            text-decoration: none;
            margin-right: 20px;
            font-weight: 500;
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border-radius: 4px;
            transition: background-color 0.15s ease-in-out;
        }
        .nav a:hover {
            background: #0056b3;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function EventDashboard() {
            const [events, setEvents] = useState([]);
            const [connectionStatus, setConnectionStatus] = useState('disconnected');

            useEffect(() => {
                const eventSource = new EventSource('/api/events/stream');

                eventSource.onopen = () => {
                    setConnectionStatus('connected');
                };

                eventSource.onmessage = (event) => {
                    try {
                        const newEvent = JSON.parse(event.data);
                        setEvents(prevEvents => {
                            const exists = prevEvents.some(e => e.id === newEvent.id);
                            if (!exists) {
                                return [newEvent, ...prevEvents].slice(0, 100);
                            }
                            return prevEvents;
                        });
                    } catch (error) {
                        console.error('Error parsing event data:', error);
                    }
                };

                eventSource.onerror = () => {
                    setConnectionStatus('disconnected');
                };

                return () => {
                    eventSource.close();
                };
            }, []);

            const formatTimestamp = (timestamp) => {
                return new Date(timestamp).toLocaleString();
            };


            return (
                <div className="container">
                    <div className="header">
                        <h1>Event Stream Dashboard</h1>
                    </div>
                    <div className="status">
                        Connection Status: 
                        <span className={connectionStatus === 'connected' ? 'connected' : 'disconnected'}>
                            {connectionStatus === 'connected' ? ' ● Connected' : ' ● Disconnected'}
                        </span>
                        {events.length > 0 && <span> | Events: {events.length}</span>}
                    </div>
                    <div className="nav">
                        <a href="/create.html">+ Create New Event</a>
                    </div>
                    <div className="table-container">
                        {events.length === 0 ? (
                            <div className="empty-state">
                                <p>No events received yet. <a href="/create.html">Create your first event</a> or make sure the database has events and the connection is established.</p>
                            </div>
                        ) : (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Title</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {events.map((event) => (
                                        <tr key={event.id}>
                                            <td className="timestamp">{formatTimestamp(event.timestamp)}</td>
                                            <td className="title">{event.title}</td>
                                            <td className="description">{event.description}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<EventDashboard />, document.getElementById('root'));
    </script>
</body>
</html>