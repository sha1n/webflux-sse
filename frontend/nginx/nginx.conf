events {
    # Maximum number of simultaneous connections per worker process
    # Default: 512, increased to handle higher concurrent loads
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging configuration
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Gzip compression for text-based responses
    # Reduces bandwidth usage and improves client load times
    gzip on;
    gzip_vary on;                # Add Vary: Accept-Encoding header
    gzip_min_length 1024;        # Only compress responses > 1KB
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;

    # ============================================================================
    # Global Proxy Settings (inherited by all proxy_pass locations)
    # ============================================================================

    # Use HTTP/1.1 for upstream connections (required for keepalive)
    # Default is HTTP/1.0 which doesn't support persistent connections
    proxy_http_version 1.1;

    # Remove Connection: close header to enable keepalive connections to upstreams
    # Without this, nginx closes connections after each request despite keepalive directive
    proxy_set_header Connection '';

    # Forward original client information to upstream servers
    proxy_set_header Host $host;                                    # Original host header
    proxy_set_header X-Real-IP $remote_addr;                        # Client IP address
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;    # Chain of proxy IPs
    proxy_set_header X-Forwarded-Proto $scheme;                     # Original protocol (http/https)

    # ============================================================================
    # Upstream Backend Services
    # ============================================================================
    # DOCKER_HOST_IP placeholder is replaced by configure-nginx-host.sh script
    # at startup with the actual host IP address for portability across machines

    upstream search-service {
        server 192.168.1.191:8081;

        # Pool of 128 idle keepalive connections to reuse
        # Dramatically reduces TCP handshake overhead under high load
        # Value should match expected peak concurrent requests to this service
        keepalive 128;
    }

    upstream authorization-service {
        server 192.168.1.191:8082;
        keepalive 128;
    }

    server {
        listen 80;
        server_name localhost;

        # Root directory for static files
        root /usr/share/nginx/html;
        index index.html;

        # ========================================================================
        # Static File Serving
        # ========================================================================

        # Serve static files directly from nginx with caching
        # Regex matches all common static file extensions
        location ~* \.(html|css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1h;                                 # Browser cache for 1 hour
            add_header Cache-Control "public, immutable";  # Mark as immutable for better caching
        }

        # ========================================================================
        # Search Service API Endpoints
        # ========================================================================

        # SSE event stream endpoint - /api/v1/events
        # Returns Server-Sent Events stream of all events
        location /api/v1/events {
            proxy_pass http://search-service;

            # CRITICAL: Disable buffering for unbounded reactive streams (Flux<Event>)
            # Without this, nginx buffers entire response causing memory accumulation
            # and massive backpressure that stalls the system under load
            proxy_buffering off;
            proxy_cache off;

            # Long timeout for persistent SSE connections
            # Clients keep connection open to receive events as they occur
            proxy_read_timeout 24h;

            # Enable chunked transfer encoding for streaming responses
            chunked_transfer_encoding on;
        }

        # Search endpoint - /api/rpc/v1/search
        # Returns NDJSON or SSE stream of search results with permission filtering
        location /api/rpc/v1/search {
            proxy_pass http://search-service;

            # CRITICAL: Disable buffering for streaming search results
            # Backend returns Flux<Event> that streams results as they're found
            # Buffering would accumulate all results in memory before sending
            proxy_buffering off;
            proxy_cache off;

            # Reasonable timeout for search operations
            proxy_read_timeout 60s;
        }

        # ========================================================================
        # Swagger UI / API Documentation
        # ========================================================================

        # Authorization Service Swagger UI - /auth-docs/
        # ^~ prefix modifier prevents regex location matches from overriding this
        # Important: Ensures static file location doesn't capture /auth-docs/*.js
        location ^~ /auth-docs/ {
            proxy_pass http://authorization-service/;

            # Rewrite Location redirect headers from backend to include /auth-docs/ prefix
            # Required for proper navigation within Swagger UI
            proxy_redirect ~^/(.*) /auth-docs/$1;
        }

        # Search Service Swagger UI - /search-docs/
        location ^~ /search-docs/ {
            proxy_pass http://search-service/;
            proxy_redirect ~^/(.*) /search-docs/$1;
        }

        # Swagger UI static resources (CSS, JS, webjars) - dynamic routing
        # Routes requests to correct backend based on HTTP Referer header
        # Allows both Swagger UIs to load their own static assets
        location ~ ^/(swagger-ui/|v3/api-docs|webjars/) {
            set $backend_service "search-service";

            # If referred from /auth-docs/, route to authorization service
            # Otherwise default to search service
            if ($http_referer ~ "/auth-docs/") {
                set $backend_service "authorization-service";
            }

            proxy_pass http://$backend_service;
        }

        # ========================================================================
        # Authorization Service API Endpoints
        # ========================================================================

        # Permission management endpoint - /api/v1/permissions
        # Handles CRUD operations and bulk permission grants
        # Backend returns Flux<UserEventPermission> for bulk operations
        location /api/v1/permissions {
            proxy_pass http://authorization-service;

            # CRITICAL: Disable buffering for reactive Flux responses
            # Bulk permission endpoint can return many results as a stream
            # Without this, system stalls under high load (bulk creation scenarios)
            proxy_buffering off;
            proxy_cache off;

            # Reasonable timeout for permission operations
            proxy_read_timeout 60s;
        }

        # ========================================================================
        # SPA Routing & Utilities
        # ========================================================================

        # Single Page Application fallback
        # Serves index.html for all unmatched routes to support client-side routing
        # Order matters: This location is processed last due to prefix matching rules
        location / {
            try_files $uri $uri/ /index.html;
        }

        # Health check endpoint for monitoring and Docker healthcheck
        # Returns 200 OK without hitting backend services
        location /health {
            access_log off;              # Don't log health checks to reduce noise
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }
    }
}
